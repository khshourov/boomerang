# Task 2.3: Basic Task Lifecycle (CRUD Operations)

This task focuses on implementing the full lifecycle management for scheduled tasks, including server-side ID generation, task lookups, cancellation, and automatic rescheduling for repeatable tasks.

## Objectives
- [x] Update `TimerTask` to include `taskId`, `payload`, and `repeatIntervalMs`.
- [x] Enhance `LongTermTaskStore` interface with lookup capabilities by `taskId`.
- [x] Implement a `taskId` index in `InMemoryLongTermTaskStore` for O(1) lookups.
- [x] Update `Timer` interface to include `get(String taskId)` and `cancel(String taskId)`.
- [x] Implement `cancel` logic in `TieredTimer` that coordinates between the store and the in-memory HTW.
- [x] Implement automatic rescheduling for repeatable tasks in `TieredTimer`.

## Approach

### 1. Data Model Updates
- Update `TimerTask.java`:
  - Add `private final String taskId`.
  - Add `private final byte[] payload`.
  - Add `private final long repeatIntervalMs`.
  - Add a constructor that accepts these fields.
  - Ensure `taskId` is generated via `UUID.randomUUID().toString()` if not provided.

### 2. Store Enhancements
- Update `LongTermTaskStore.java`:
  - Add `Optional<TimerTask> findById(String taskId)`.
- Update `InMemoryLongTermTaskStore.java`:
  - Add `private final Map<String, TimerTask> idIndex = new ConcurrentHashMap<>()`.
  - Update `save`, `delete`, and `fetchTasksDueBefore` to maintain the `idIndex`.

### 3. Timer Interface Updates
- Update `Timer.java`:
  - Add `void cancel(String taskId)`.
  - Add `Optional<TimerTask> get(String taskId)`.

### 4. TieredTimer Implementation
- Implement `cancel(String taskId)`:
  - Fetch `TimerTask` from `longTermStore`.
  - If present:
    - Call `task.cancel()` to remove from HTW.
    - Call `longTermStore.delete(task)`.
- Update `handleExpiredTask`:
  - If `task.getRepeatIntervalMs() > 0`:
    - Calculate `newExpirationMs = now + repeatIntervalMs`.
    - Create a NEW `TimerTask` with the same `taskId`, `payload`, and `repeatIntervalMs`.
    - Call `this.add(newTask)`.
    - *Note:* We always create a new task object to ensure the expiration time remains immutable within a single `TimerTask` instance, which is safer for the timing wheel's bucket logic.

### 5. Verification
- Add unit tests in `TieredTimerTest.java` and `InMemoryLongTermTaskStoreTest.java` to verify:
  - Task registration returns a valid `taskId`.
  - Task can be retrieved by `taskId`.
  - Task can be cancelled by `taskId`, and it won't fire.
  - Repeatable tasks fire multiple times at the correct intervals.
- Ensure mutation tests (PITest) pass with >80% score.
