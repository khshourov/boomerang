# Task 2.2: Implement Tiered Scheduling Logic

This task focuses on implementing the "Imminent vs. Long-term" task transition logic. It ensures that tasks scheduled for the near future (< 30 minutes) are managed in-memory by the Hierarchical Timing Wheel (HTW), while long-term tasks are offloaded to persistent storage.

## Prerequisites
- [x] Task 2.1: Implement Hierarchical Timing Wheel (HTW).

## Objectives
- Implement a `TieredTimer` wrapper that coordinates between the HTW and long-term storage.
- Define a `LongTermTaskStore` interface for Phase 3 (RocksDB integration).
- Implement a 30-minute "Imminent" window logic for task routing.
- Implement reactive loading: trigger a fetch from long-term storage when the HTW clock advances into a new window.

## Technical Details
- **Imminent Window:** 30 minutes (configurable).
- **Routing Logic:**
    - If `task.expirationMs - currentTime < 30m`, add to HTW.
    - Otherwise, add to `LongTermTaskStore`.
- **Loading Logic (Reactive):**
    - The `TieredTimer` monitors the HTW clock advancement.
    - When the clock crosses a certain threshold (e.g., every 15 minutes), it fetches the next 15-minute chunk from the `LongTermTaskStore` and populates the HTW.
- **`LongTermTaskStore` Interface:**
    - `void save(TimerTask task)`
    - `List<TimerTask> fetchTasksDueBefore(long timestamp)`
    - `void delete(String taskId)`

## Implementation Steps

### 1. Define Interface & Stub
- [x] Create `LongTermTaskStore.java` interface.
- [x] Create `InMemoryLongTermTaskStore.java` (stub) for testing and development.

### 2. Implement `TieredTimer`
- [x] Wrapper class implementing the `Timer` interface.
- [x] Constructor accepting `HierarchicalTimingWheel`, `LongTermTaskStore`, and configuration.
- [x] Logic in `add(TimerTask)` to route tasks.
- [x] Background/Reactive logic to pull tasks from `LongTermTaskStore` into HTW.

### 3. Testing Strategy
- [x] **Routing Test:** Verify tasks with short vs. long delays go to the correct store.
- [x] **Transition Test:** Verify that long-term tasks are eventually loaded into the HTW and executed when their time comes.
- [x] **Boundary Test:** Test tasks scheduled exactly at the 30-minute mark.
- [x] **Concurrency Test:** Ensure adding tasks and transitioning tasks doesn't cause race conditions.

## Success Criteria
- [x] Tasks > 30m are NOT added to the HTW initially.
- [x] Tasks > 30m are eventually executed by the HTW after their transition.
- [x] Unit tests verify the tiered logic with 80%+ coverage. (Achieved 100% for new classes).
