# Task 5.2: Management API & Task Listing

Implement the Management API for listing and retrieving scheduled tasks with advanced filtering and pagination.

## Sub-tasks

1.  **Update Protobuf Schema:**
    *   Add `ListTasksRequest`, `ListTasksResponse`, `GetTaskRequest`, and `GetTaskResponse` to `boomerang.proto`.
    *   Include filtering options: `client_id`, `scheduled_after`, `scheduled_before`, `is_recurring`.
    *   Include pagination: `limit`, `offset`.
    *   Update `BoomerangEnvelope` to include the new messages.

2.  **Extend Timer and LongTermTaskStore Interfaces:**
    *   Add `listTasks` method to `Timer` interface.
    *   Add `listTasks` method to `LongTermTaskStore` interface.

3.  **Implement `listTasks` in RocksDBLongTermTaskStore:**
    *   Implement efficient range scanning using `time_index`.
    *   Apply filters for `client_id` and `is_recurring` during iteration.
    *   Implement pagination using `limit` and `offset`.

4.  **Implement `listTasks` in TieredTimer:**
    *   Delegate `listTasks` to the `LongTermTaskStore`.
    *   Ensure consistency (HTW tasks are already persisted in the store).

5.  **Update BoomerangServerHandler:**
    *   Handle `LIST_TASKS_REQUEST` and `GET_TASK_REQUEST`.
    *   Enforce security: 
        *   Admins can list tasks for any `client_id` or all clients.
        *   Regular clients can only list/get their own tasks.
    *   Map results to Protobuf responses using `ModelMapper`.

6.  **Verification & Testing:**
    *   Add unit tests for `RocksDBLongTermTaskStore.listTasks`.
    *   Add unit tests for `TieredTimer.listTasks`.
    *   Add integration tests in `BoomerangServerHandler` (or a dedicated integration test class) to verify the end-to-end flow.
    *   Verify pagination and all filtering combinations.

## Clarification Questions

1.  **Pagination Performance:** For very large numbers of tasks, `offset`-based pagination in RocksDB might become slow as it requires skipping entries. Should we consider cursor-based pagination (e.g., `next_token` based on the last `(expirationMs, taskId)`)?
2.  **Recurring Task Filter:** The `is_recurring` filter depends on `repeatIntervalMs > 0`. Is this sufficient, or do we need more complex recurring logic later?
3.  **Client ID Filtering:** When an Admin lists tasks without specifying a `client_id`, should it return tasks for all clients? (Assuming yes based on the plan).
