# Task 4.1: Implement Netty-based Protobuf/TCP Server

## Objective
Implement a high-performance Netty-based TCP server that handles Protobuf-encoded `BoomerangEnvelope` messages. This server will be the primary entry point for task registration, cancellation, and session management.

## Requirements
1.  **Server Lifecycle:**
    -   The server must be a separate component (e.g., `BoomerangServer`) managed by `BoomerangBootstrap`.
    -   Support clean startup and shutdown via `BoomerangBootstrap`.
2.  **Protocol:**
    -   Use Protobuf for serialization/deserialization.
    -   Implement a framing mechanism (e.g., `LengthFieldPrepender` and `LengthFieldBasedFrameDecoder`) to handle TCP stream fragmentation.
3.  **Handlers:**
    -   Implement a `BoomerangServerHandler` that processes all payload types in `BoomerangEnvelope`:
        -   `AuthHandshake` -> `AuthService`
        -   `Task` (registration) -> `Timer`
        -   `CancellationRequest` -> `Timer`
        -   `SessionRefreshRequest` -> `SessionManager`
        -   `ClientRegistrationRequest` -> `AuthService`
        -   `ClientDeregistrationRequest` -> `AuthService`
4.  **Threading Model:**
    -   Netty `EventLoopGroup` for I/O.
    -   A separate `ExecutorService` (worker pool) for processing business logic to avoid blocking the I/O threads.
    -   Verify thread safety of `Timer`, `AuthService`, `SessionManager`, and `LongTermTaskStore`.
5.  **Configuration:**
    -   Add the following to `ServerConfig` and `boomerang-server.properties`:
        -   `server.port` (Default: `9973`)
        -   `netty.boss.threads` (Default: 1)
        -   `netty.worker.threads` (Default: 0 - Netty default)
        -   `netty.business.threads` (Default: Math.max(1, Runtime.getRuntime().availableProcessors() * 2))
6.  **Validation:**
    -   Unit tests for `BoomerangServerHandler`.
    -   Integration tests for the full TCP lifecycle (Connect -> Auth -> Register Task -> Disconnect).
    -   Verification of thread safety across core components.

## Implementation Steps
1.  **Update `ServerConfig`:** Add Netty and Server properties.
2.  **Create `BoomerangServer`:** Initialize Netty `ServerBootstrap`.
3.  **Implement `ProtobufFrameEncoder/Decoder`:** Configure Netty pipeline for Protobuf.
4.  **Implement `BoomerangServerHandler`:** Logic for routing messages to services.
5.  **Integrate with `BoomerangBootstrap`:** Instantiate and start `BoomerangServer`.
6.  **Add Tests:** Ensure correctness and reliability.
