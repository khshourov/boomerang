# Task 1.1: Define Protobuf Schema

## Status: Complete âœ…

## Objective
Define the Protobuf schema to support a session-based communication model where client configuration is negotiated during handshake and referenced via `session_id`.

## Implementation Details
- Created `proto/boomerang.proto` with:
    - **Session-Based Envelope:** `BoomerangEnvelope` now includes a `session_id`.
    - **Handshake Config:** `AuthHandshake` captures session-wide `CallbackConfig`, `RetryPolicy`, and `DLQPolicy`.
    - **Refined Retry Policy:** `RetryPolicy` includes `interval_ms` (for fixed or initial exponential) and `max_interval_ms` (cap for exponential).
    - **Simplified Task:** The `Task` message is stripped of configuration, which is enforced from the session.
    - **Session Management:** Added `SessionRefreshRequest` and `SessionRefreshResponse` with `expires_at_ms`.
    - **Error Handling:** Added `SESSION_EXPIRED` to the `Status` enum.

## Field Explanations
- **DLQPolicy.destination:** Specifies the "parking lot" for tasks that exhaust all retry attempts. This can be a logical bucket name in internal storage (RocksDB), an external webhook URL, or a topic name for an external message broker, ensuring failed tasks are durable and reviewable.

## Scope
- **Session Handshake:**
    - `AuthHandshake`: Token + `CallbackConfig` + `RetryPolicy` + `DLQPolicy`.
    - `AuthResponse`: `session_id` + `Status`.
- **Task Management:**
    - `Task`: Payload + Scheduling + `session_id` (replaces inline config).
    - `CancellationRequest`: `TaskID` + `session_id`.
- **Envelope:** Updated `BoomerangEnvelope` to support session-based flow.

## Decisions Made
- **TaskID:** Server-generated UUID.
- **Scheduling:** Relative delay only.
- **Recurrence:** Fixed interval only.
- **Inbound Protocol:** Raw Message Exchange (Custom TCP) with Envelope.
- **Session Management:**
    - **Persistence:** Volatile (memory-only).
    - **Overrides:** No task-level overrides allowed.
    - **Placement:** `session_id` at the `BoomerangEnvelope` level.
    - **Lifecycle:** Timeout-based; client must refresh session.
    - **Handshake:** `AuthHandshake` provides configs; `AuthResponse` returns `session_id`.

## Open Questions
- None.

## Scope
- Define the `Task` message covering:
    - `Payload`: Raw binary data to be returned.
    - `Scheduling`: Relative delay (milliseconds).
    - `Recurrence`: Fixed interval (milliseconds).
    - `CallbackConfig`: Protocol and endpoint (client implements Boomerang's enforced format).
    - `RetryPolicy`: Max attempts, backoff strategy.
    - `DLQPolicy`: Dead Letter Queue destination/configuration.
- Define `RegistrationResponse`:
    - `TaskID`: Server-generated UUID (String).
    - `Status`: Success/Error codes.
    - `ScheduledTime`: Absolute time the task is first scheduled for.
- Define `CancellationRequest`:
    - `TaskID`: The task to cancel.
- Define `CancellationResponse`:
    - `Status`: Confirmation.
- Define `AuthHandshake`:
    - `AuthToken`: Initial connection-level authentication.

## Decisions Made
- **TaskID:** Server-generated UUID.
- **Scheduling:** Relative delay only.
- **Recurrence:** Fixed interval only.
- **Callback:** Enforced Boomerang format for all protocols (TCP, gRPC, HTTP, UDP).
- **Authentication:** Connection/handshake level (not per-message).
- **Inbound Protocol:** Approach 2 (Raw Message Exchange / Custom TCP) using an envelope pattern.

## Open Questions
- None.

## Dependencies
- None (Initial project setup).
