# Task 2.1: Implement Hierarchical Timing Wheel (HTW)

This task focuses on implementing the core in-memory scheduling engine using a Hierarchical Timing Wheel (HTW) to handle imminent tasks (within a 30-minute window) with O(1) performance.

## Prerequisites
- [x] Phase 1 Foundation & Contract Definition.
- [x] Discussion on clock advancement and tick duration.

## Objectives
- Create a high-precision, low-latency in-memory scheduler.
- Support O(1) task insertion and cancellation.
- Use a `DelayQueue` for efficient clock advancement (Kafka-style).
- Implement hierarchical levels to cover at least a 30-minute window with 10ms tick precision.

## Technical Details
- **Base Tick Duration:** 10ms.
- **Buckets per Level:** 64 (allows efficient bitmasking: `index = (expiration / tick) & 63`).
- **Memory Window:** ~43 minutes (Level 3 covers `10ms * 64 * 64 * 64 = 2,621,440ms`).
- **Thread Safety:** Use synchronized buckets or concurrent data structures to handle high-frequency additions and expirations.
- **Decoupling:** The HTW will yield expired tasks to a provided `Consumer<TimerTask>` rather than executing them directly.

## Implementation Steps

### 1. Data Structures
- **`TimerTask`:**
    - `long expirationMs`: Absolute time in milliseconds when the task should fire.
    - `Runnable task`: The logic to execute (or a wrapper for the Protobuf payload).
    - `TimerBucket bucket`: Reference to the current bucket for O(1) cancellation.
- **`TimerBucket`:**
    - `Long expiration`: The absolute time this bucket represents.
    - `Delayed` implementation to work with `DelayQueue`.
    - Doubly-linked list of `TimerTask` for O(1) removal.

### 2. Core Logic
- **`TimingWheel`:**
    - Tracks `tickDuration`, `wheelSize`, `interval`, and `currentTime`.
    - Manages an array of `TimerBucket`.
    - Handles "overflow" to a parent `TimingWheel` if a task's expiration exceeds the current wheel's range.
- **`HierarchicalTimingWheel`:**
    - Manages the root `TimingWheel`.
    - Uses a `DelayQueue<TimerBucket>` to track non-empty buckets.
    - Maintains a dedicated `workerThread` to poll the `DelayQueue` and advance the clock.
    - Provides `addTask(TimerTask)` and `advanceClock(long timeMs)`.

### 3. Testing Strategy
- **Precision Test:** Verify tasks fire within a reasonable margin of the 10ms tick.
- **Overflow Test:** Add tasks that span multiple wheel levels and verify they are correctly re-inserted into lower levels as time passes.
- **Cancellation Test:** Ensure tasks can be removed from any level in O(1).
- **Concurrency Test:** Add and cancel tasks from multiple threads while the clock is advancing.

## Success Criteria
- [x] 90%+ code coverage for the `io.boomerang.timer` package.
- [x] Tasks added for the future are correctly expired at the right time.
- [x] Clock advancement handles empty periods efficiently via `DelayQueue`.
- [x] No memory leaks (ensure cancelled/expired tasks are fully dereferenced).
