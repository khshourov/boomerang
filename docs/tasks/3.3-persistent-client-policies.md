# Task 3.3: Persistent Client Policies

Implement persistent storage for client-specific execution policies (`CallbackConfig`, `RetryPolicy`, `DLQPolicy`) within the client registration record. This ensures that every task scheduled by a client inherits their default policies without needing to pass them during every handshake.

## Status
- **Status:** Completed
- **Assignee:** Gemini CLI
- **Created:** 2026-02-20
- **Last Updated:** 2026-02-20

## Requirements

1.  **Protocol Updates:**
    -   Add `ClientRegistrationRequest` and `ClientRegistrationResponse` to `boomerang.proto`.
    -   Include `CallbackConfig`, `RetryPolicy`, and `DLQPolicy` in the registration request.
    -   Add `ClientDeregistrationRequest` for completeness.
2.  **Model Enhancements:**
    -   Update the `Client` record to store the new policy fields.
3.  **Durable Storage:**
    -   Update `RocksDBClientStore` to serialize and encrypt the new policy fields alongside credentials.
4.  **Handshake Logic:**
    -   During `AuthHandshake`, the server should retrieve the client's registered policies and embed them into the created `Session`.
5.  **Task Lifecycle:**
    -   Since sessions are now transient but contain durable policies, tasks reloaded from disk can still function as long as we maintain the mapping of Task -> Client (or ensure the task carries its resolved policies).

## Sub-tasks

- [x] **Protobuf Definition:**
    - [x] Add `ClientRegistrationRequest` and `ClientDeregistrationRequest`.
    - [x] Update `BoomerangEnvelope` to include these new payloads.
- [x] **Core Model Update:**
    - [x] Update `io.boomerang.model.Client` to include policy fields.
- [x] **Storage Refactoring:**
    - [x] Update `RocksDBClientStore` serialization to handle policies.
    - [x] Ensure existing tests are updated for the new schema.
- [x] **Auth & Session Integration:**
    - [x] Update `AuthService` to handle the new registration request.
    - [x] Update `SessionManager` to create sessions using client-level policies.
- [x] **Verification:**
    - [x] Unit tests for policy-aware client registration.
    - [x] Integration tests verifying that a task scheduled under a session correctly uses the client's registered policies.

## Constraints
- Follow project standards for Javadoc and code style.
- Maintain at least 80% code coverage and mutation score.
