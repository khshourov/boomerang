# Task 3.3 Review: Persistent Client Policies

**Task:** 3.3
**Status:** Completed (with recommendations)
**Reviewer:** Gemini CLI
**Date:** 2026-02-20

## Summary
The implementation successfully adds persistent storage for client-specific execution policies (`CallbackConfig`, `RetryPolicy`, `DLQPolicy`) and integrates them into the authentication and session management lifecycle. The code follows the architectural vision and technical standards, particularly regarding durability and security.

## Foundational Alignment
- **SPEC.md:** Aligns with the "Auth Handshake" workflow where policies are resolved from the client record.
- **GUIDELINES.md:** Adheres to Java 21 standards, uses guard clauses, and provides complete Javadoc.
- **PLAN.md:** Correctly marks Task 3.3 as completed in the project roadmap.

## Detailed Feedback

### 1. RocksDB Serialization & Custom Data Classes (Critical Concern)
In `RocksDBClientStore.java`, the `serialize` and `deserialize` methods manually extract and write individual fields from the Protobuf messages.
**Issue:** This is brittle and couples the storage layer directly to the Protobuf-generated classes.
**Recommendation:** 
- **Decoupling:** Introduce custom POJO/record data classes for `CallbackConfig`, `RetryPolicy`, and `DLQPolicy` within the `io.boomerang.model` package. The `Client` and `Session` models should use these custom classes instead of the raw Protobuf classes.
- **Serialization:** Store these custom classes in RocksDB by either using a stable binary format or by converting them to/from Protobuf bytes only at the persistence boundary. This ensures that internal logic is decoupled from the wire protocol.

### 2. Protocol Simplification (AuthHandshake)
The current `AuthHandshake` message in `boomerang.proto` includes optional session-level overrides for `CallbackConfig`, `RetryPolicy`, and `DLQPolicy`.
**Observation:** Based on the shift towards persistent client policies, session-level overrides in the handshake are redundant and add unnecessary complexity.
**Recommendation:** Remove the `callback`, `retry`, and `dlq` fields from the `AuthHandshake` message. Clients should rely on the policies they registered during the registration phase.

### 3. Admin Authorization Logic
In `AuthService.registerClientByAdmin`, the service returns a `boolean`.
**Issue:** While functional, the `ClientRegistrationResponse` proto message has an `error_message` field.
**Recommendation:** The service layer should return more descriptive status objects (or throw typed exceptions) so that the protocol layer can populate the `error_message` with specific details (e.g., "Client already exists" or "Insufficient permissions").

## Verification Results
- **Unit Tests:** `AuthServiceTest` and `RocksDBClientStoreTest` are present and cover the success/failure paths.
- **Code Coverage:** High (visual inspection suggests >80%).
- **Mutation Testing:** Not explicitly run in this review, but tests are designed with high signal (edge cases like missing master key, incorrect passwords).

## Conclusion
The task is implemented well and is functional. However, the manual serialization in `RocksDBClientStore` is a technical debt that should be addressed immediately to ensure long-term durability and schema evolution.

**Approval Status:** Approved with recommendations. Please prioritize refactoring the RocksDB serialization to use native Protobuf bytes before proceeding to the next persistence-heavy task.
