# Task 3.4: Implement Recovery Logic

This task involves implementing and verifying the system startup logic to reload tasks from RocksDB into the `HierarchicalTimingWheel` (HTW) via `TieredTimer`.

## Objective
Ensure that all persistent tasks (scheduled and stored in RocksDB) are correctly reloaded and rescheduled when the Boomerang server starts up, particularly after an unexpected shutdown.

## Context
Boomerang uses a tiered scheduling approach:
- **Imminent Tasks (< 30m):** Kept in-memory in the HTW for efficiency.
- **Long-term Tasks (> 30m):** Persisted to RocksDB.
- **Recovery:** On startup, the server must scan RocksDB for all tasks due within the imminent window (and any overdue tasks) and load them into the HTW.

The `TieredTimer` class already contains the core logic for this in its constructor and `reactiveLoad()` method. This task focuses on wiring it into the server's bootstrap and ensuring its correct operation at the system level.

## Requirements
1.  **Integrate `TieredTimer` into `BoomerangBootstrap`:**
    *   Initialize `RocksDBLongTermTaskStore` in `BoomerangBootstrap`.
    *   Initialize `TieredTimer` in `BoomerangBootstrap` using the store and a placeholder logging dispatcher.
    *   Expose a way to interact with the `Timer` from `BoomerangBootstrap` (e.g., `getTimer()`).
    *   Properly shut down `TieredTimer` and its store in `BoomerangBootstrap.close()`.
2.  **Verify Recovery Logic:**
    *   Add an integration test to `BoomerangBootstrapTest` that verifies the full lifecycle:
        1.  Start a `BoomerangBootstrap` instance.
        2.  Schedule a task via the `Timer`.
        3.  Stop the bootstrap instance.
        4.  Start a NEW `BoomerangBootstrap` instance pointing to the same RocksDB directory.
        5.  Verify that the task is reloaded and eventually dispatched (captured by the logging dispatcher).
3.  **Refine Performance (Optional/If Necessary):**
    *   Ensure that the initial `reactiveLoad` in `TieredTimer`'s constructor handles potentially large numbers of tasks without causing excessive delays or OOM errors.

## Success Criteria
- [x] `TieredTimer` and `RocksDBLongTermTaskStore` are correctly initialized and managed by `BoomerangBootstrap`.
- [x] Tasks scheduled before a restart are correctly reloaded and executed after the restart.
- [x] Integration tests pass consistently.
- [x] Code follows project standards (Javadoc, tests, etc.).

## References
- `io.boomerang.timer.TieredTimer`
- `io.boomerang.timer.RocksDBLongTermTaskStore`
- `io.boomerang.BoomerangBootstrap`
- `docs/PLAN.md` (Task 3.4)
