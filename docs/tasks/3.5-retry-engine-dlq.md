# Task 3.5: Retry Engine & DLQ

Implement the retry loop logic and persistent Dead Letter Queue (DLQ) to ensure reliability and "at-least-once" delivery.

## Sub-tasks
1. [x] **Update TimerTask Model:**
   - Add `clientId` and `attemptCount` to `TimerTask.java`.
   - `RetryPolicy` and `DLQPolicy` will *not* be stored in `TimerTask`; they will be retrieved from the `Client` object using the `clientId`.
   - Update constructors and factory methods.
2. [x] **Update Serialization:**
   - Update `TimerTaskSerializer.java` to handle the new fields.
   - Update `RocksDBLongTermTaskStore` if necessary to handle any changes in serialization (though it uses the serializer).
3. [x] **Persistent DLQ Store:**
   - Create `DLQStore.java` interface.
   - Implement `RocksDBDLQStore.java` using a new Column Family in the existing RocksDB instance.
   - Add `rocksdb.dlq_cf` to configuration if needed.
4. [x] **Retry Engine Logic:**
   - Create `RetryEngine.java` interface.
   - Implement `DefaultRetryEngine.java` which:
     - Calculates backoff delay based on `RetryPolicy` (FIXED or EXPONENTIAL).
     - Increments `attemptCount`.
     - Reschedules the task via `Timer` if retries remain.
     - Moves the task to `DLQStore` if retries are exhausted.
5. [x] **TieredTimer Integration:**
   - Update `TieredTimer.handleExpiredTask` to:
     - Catch exceptions from `dispatcher.accept(task)`.
     - Call `RetryEngine.handleFailure(task, exception)`.
     - Ensure task deletion from `LongTermTaskStore` only occurs on successful dispatch or movement to DLQ.
6. [x] **Testing:**
   - Unit tests for `RetryEngine` backoff calculations.
   - Unit tests for `RocksDBDLQStore`.
   - Integration tests verifying the full retry-to-DLQ flow.

## Technical Details
- **Backoff Calculation:**
  - `FIXED`: nextDelay = `intervalMs`.
  - `EXPONENTIAL`: nextDelay = `min(intervalMs * 2^(attemptCount-1), maxIntervalMs)`.
- **DLQ Storage:**
  - Key: `taskId`.
  - Value: Serialized `TimerTask` + Failure context (error message, timestamp).
- **Retry Integration:** `TieredTimer` will now require a `RetryEngine` instance.
